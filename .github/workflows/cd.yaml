name: Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    uses: ./.github/workflows/ci.yml
    secrets: inherit
  deploy:
    needs: build
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
      OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}
    steps:
      - uses: actions/checkout@v4
      - name: Configure OCI CLI and Kubectl for OKE
        uses: oracle-actions/configure-kubectl-oke@v1.5.0
        with:
          cluster: ${{ secrets.OKE_CLUSTER_OCID }}
      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Deploy Helm chart
        run: |
          helm upgrade --install release1 $GITHUB_WORKSPACE/helm-chart \
            --namespace default \
            --create-namespace \
            --wait \
            --timeout 15m \
            --set image.tag=latest

      - name: Verify deployment
        run: |
          echo "=== Helm Release Status ==="
          helm status release1 --namespace default
          
          echo ""
          echo "=== Pods ==="
          kubectl get pods --namespace default -l app.kubernetes.io/name=deployment-test
          
          echo ""
          echo "=== Services ==="
          kubectl get svc --namespace default
          
          echo ""
          echo "=== Deployment Status ==="
          kubectl rollout status deployment/release1 --namespace default
#    steps:
#      - name: Trigger Render Deploy
#        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}