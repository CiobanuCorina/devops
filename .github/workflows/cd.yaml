name: Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    uses: ./.github/workflows/ci.yml
    secrets: inherit
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
        shell: bash
      - name: Copy Helm chart to VM
        run: |
          scp -i ~/.ssh/id_rsa -r ./helm-chart ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:~/
        shell: bash
      - name: Deploy Helm Chart on VM
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

          sudo helm upgrade --install my-release ~/helm-chart \
            --namespace default \
            --create-namespace \
            --wait \
            --timeout 5m \
            --set image.tag=${{ github.sha }}

          sudo kubectl get pods -n default
          sudo kubectl get services -n default
          EOF
        shell: bash
#    steps:
#      - name: Trigger Render Deploy
#        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}